# The language in this case has no bearing - we are going to be making use of "conda" for a
# python distribution for the scientific python stack.
language: c

os:
  - linux
  - osx

osx_image: xcode6.4

env:

    matrix:
        - PYTHON_VERSION=3.6
        - PYTHON_VERSION=2.7
        - PYTHON_VERSION=3.5

    global:
        - DESTINATION_CONDA_CHANNEL="nickhand"
        - TARGET_ARCH="x64"
        - CONDA_INSTALL_LOCN="${HOME}/miniconda"

        # Defines BINSTAR_TOKEN for your binstar channel
        - secure: "MmbSlIIWP12Hdkob5JjPAPAxbrFZEGNr4Oa9H6IFG4fC6A6Igz4GCqWAOeMkx6Teg4RGp1xeDHPr+4Zvk9mw0JdF8p1AGgReUZE3bj61Grj+e5bVgGeVoCTSAh8yenss02x4T73d5VmiVYL83rGZELX2JQ+sE4c7krElJio6t8bnXL5PayWt1FTISvLC1FHmNflT8y4LidYAJp7T8Fii0ASjOxEk2wxzwMT6hc8s7DX169C5zrW1cDcHYHFIh03E17Gu4zPuxg87pcjMpO5fIqbo5DSZKkwSblphchB7X+FpWf7WVqnGxn/1GhAZQ2XN6tw6xEwFhLEL9L9MTi9c6tv3nEWwVF70C0fV6N+y2uROVRIiqaM40vbLB6B6H1tp53VX+cSfFUjD7g4bm/juguAj5xKT7KnmsMGXSsBwv3ixPwuiQPDQaWK8J+sAxVx5DRKpgUvk5HclakipCjLWHGWGcrhpLACIK+MF1mpVEjtGCvDEvFT6I9gk0Jrbf2Wqi7Z7tUOgyHj0l7zADgXq7Bvo1Ta37chn5xHxwJtVNYRrU6nzgiTMh2RZH6UdOkCiYJ96kC6WLNQjaCcNUaukOFjY94bgSr/R+l8tY5CCAfXUz3MEn4vOSh/OVARb/8Gv8TXXsXFU8cO8rHi8xXIIzVMXgp2ew6JEPoqlezzWKZY="

install:
    # Install and set up miniconda.
    - if [ $TRAVIS_OS_NAME == "linux" ]; then wget http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh; fi
    - if [ $TRAVIS_OS_NAME == "osx" ]; then wget http://repo.continuum.io/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O miniconda.sh; fi
    - bash miniconda.sh -b -p $CONDA_INSTALL_LOCN
    - export PATH=${CONDA_INSTALL_LOCN}/bin:$PATH
    - conda config --set always_yes true

    - conda install --quiet conda

    # so we can grab compiled packages for dependencies
    - conda config --prepend channels nickhand
    - conda config --append channels bccp
    - conda config --append channels astropy
    - conda config --prepend channels defaults
    - conda config --append channels conda-forge # need for george dependencies

    # Install a couple of dependencies we need for sure.
    - conda install --quiet --yes astropy anaconda-client=1.6.2 jinja2 cython pycrypto
    - conda install ruamel_yaml

    # latest conda build
    - conda install conda-build

    # To ease debugging, list installed packages
    - conda info -a
    - conda list
    - |
      # Only upload if this is NOT a pull request.
      if [ "$TRAVIS_PULL_REQUEST" = "false" ] && \
         [ $TRAVIS_REPO_SLUG = "nickhand/pyRSD-conda-channel" ] && \
         [ "$TRAVIS_BRANCH" == "master" ]; then
          UPLOAD="--user $DESTINATION_CONDA_CHANNEL --token $BINSTAR_TOKEN";
          conda config --set anaconda_upload true
          echo "Uploading enabled";
      else
          echo "Uplading disabled";
          UPLOAD="";
      fi

script:
    - INSPECT="--skip-existing -c nickhand"
    - VARIANT=variants/python-${PYTHON_VERSION}.yaml
    - python extrude_recipes.py requirements.yml
    # Packages are uploaded as they are built.
    - bash build-all.sh -m $VARIANT $INSPECT $UPLOAD

after_success:
    # build the documentation
    - curl -X POST https://readthedocs.org/build/pyrsd/latest
